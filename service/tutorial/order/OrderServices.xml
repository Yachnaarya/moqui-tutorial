<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <!--    Assignment 2-->

    <!--    Created Order-->
    <service verb="create" noun="Order" displayName="Create an order">
        <in-parameters>
            <parameter name="orderName" required="true"/>
            <parameter name="currencyUomId" default-value="USD"/>
            <parameter name="salesChannelEnumId"/>
            <parameter name="statusId" default-value="orderPlaced"/>
            <parameter name="productStoreId"/>
            <parameter name="placedDate" required="true"/>
            <parameter name="approvedDate"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId"/>
        </out-parameters>
        <actions>
            <!--Creating Orders in the OrderHeader -->
            <service-call name="create#mantle.order.OrderHeader" in-map="context" out-map="context"/>
        </actions>
    </service>

    <!--    Added Order Items-->

    <service verb="add" noun="OrderPart" displayName="Add an order">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="partName"/>
            <parameter name="facilityId" required="true"/>
            <parameter name="shipmentMethodEnumId" default-value="ShMthGround"/>
            <parameter name="customerPartyId"/>
            <parameter name="item_details" type="List">
                <parameter name="orderMap" type="Map">
                    <parameter name="productId" required="true"/>
                    <parameter name="itemDescription" required="true"/>
                    <parameter name="quantity" required="true"/>
                    <parameter name="unitAmount" required="true"/>
                </parameter>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId"/>
            <parameter name="orderPartSeqId"/>
        </out-parameters>
        <actions>
            <!-- Check if the OrderHeader is existing for the given orderId -->
            <entity-find-one entity-name="OrderHeader" value-field="orderHeader">
                <field-map field-name="orderId"/>
            </entity-find-one>
            <if condition="orderHeader">
                <then>
                    <!--If orderId exit then create else return an error -->
                    <service-call name="create#mantle.order.OrderPart" in-map="context" out-map="context"/>
                </then>
                <else>
                    <return error="true" message="Order doesn't exists." type="danger"/>
                </else>
            </if>
            <set field="orderPartSeqId" from="orderPartSeqId"/>
            <iterate list="item_details" entry="item">
                <set field="productId" from="item.productId"/>
                <!-- Finding productId in the Product entity -->
                <entity-find-one entity-name="mantle.product.Product" value-field="product">
                    <field-map field-name="productId"/>
                </entity-find-one>
                <!-- If productId exist then create order items -->
                <if condition="product">
                    <then>
                        <service-call name="create#mantle.order.OrderItem" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, productId:item.productId,
                                  itemDescription:item.itemDescription,unitAmount:item.unitAmount, quantity:item.quantity]"
                                      out-map="context"/>
                    </then>
                    <else>
                        <!-- If productId doesn't exist then return an error -->
                        <return error="true" message="product doesn't exists." type="danger"/>
                    </else>
                </if>
            </iterate>
        </actions>
    </service>

    <!--Get all Orders-->

    <service verb="get" noun="OrderList" displayName="Get all order">
        <out-parameters>
            <parameter name="orders" type="list">
                <parameter name="orderId"/>
                <parameter name="orderName"/>
                <parameter name="currencyUomId"/>
                <parameter name="salesChannelEnumId"/>
                <parameter name="statusId"/>
                <parameter name="placedDate"/>
                <parameter name="grandTotal"/>
                <parameter name="customer_details" type="map">
                    <parameter name="firstName"/>
                    <parameter name="middleName"/>
                    <parameter name="lastName"/>
                </parameter>
                <parameter name="order_parts" type="list">
                    <parameter name="orderPartSeqId"/>
                    <parameter name="partName"/>
                    <parameter name="facilityId"/>
                    <parameter name="shipmentMethodEnumId"/>
                    <parameter name="partStatusId"/>
                    <parameter name="partTotal"/>
                    <parameter name="item_details" type="list">
                        <parameter name="orderItemSeqId"/>
                        <parameter name="productId"/>
                        <parameter name="itemDescription"/>
                        <parameter name="quantity"/>
                        <parameter name="unitAmount"/>
                    </parameter>
                </parameter>
            </parameter>
        </out-parameters>
        <actions>
            <set field="orders" from="[]"/>
            <!-- Getting all Order records of the OrderHeader entity -->
            <entity-find entity-name="mantle.order.OrderHeader" list="orderList">
                <select-field field-name="orderId,orderName,currencyUomId,placedDate,grandTotal"/>
            </entity-find>
            <!-- Traversing the orderList -->
            <iterate list="orderList" entry="orderMap">
                <set field="orderId" from="orderMap.orderId"/>
                <set field="orderName" from="orderMap.orderName"/>
                <set field="currencyUomId" from="orderMap.currencyUomId"/>
                <set field="salesChannelEnumId" from="orderMap.salesChannelEnumId"/>
                <set field="statusId" from="orderMap.statusId"/>
                <set field="placedDate" from="orderMap.placedDate"/>
                <set field="grandTotal" from="orderMap.grandTotal"/>
                <set field="order_parts" from="[]"/>
                <entity-find entity-name="mantle.order.OrderPart" list="orderPartList">
                    <econdition field-name="orderId" from="orderId"/>
                    <select-field
                            field-name="orderId,orderPartSeqId,customerPartyId,partName,facilityId,shipmentMethodEnumId,statusId,partTotal"/>
                </entity-find>
                <!-- Traversing the orderPartList -->
                <set field="item_details" from="[]"/>
                <iterate list="orderPartList" entry="orderPartMap">
                    <!-- Fetching OrderItem on orderId and orderPartSeqId-->
                    <entity-find entity-name="mantle.order.OrderItem" list="orderItemList">
                        <econdition field-name="orderId" from="orderPartMap.orderId"/>
                        <econdition field-name="orderPartSeqId" from="orderPartMap.orderPartSeqId"/>
                        <select-field field-name="orderItemSeqId,productId,itemDescription,quantity,unitAmount"/>
                    </entity-find>
                    <!-- Traversing the orderItemList -->
                    <iterate list="orderItemList" entry="orderItemMap">
                        <set field="orderItemSeqId" from="orderItemMap.orderItemSeqId"/>
                        <set field="productId" from="orderItemMap.productId"/>
                        <set field="itemDescription" from="orderItemMap.itemDescription"/>
                        <set field="quantity" from="orderItemMap.quantity"/>
                        <set field="unitAmount" from="orderItemMap.unitAmount"/>
                        <script>item_details.add([orderItemSeqId:orderItemSeqId, productId:productId,
                            itemDescription:itemDescription, quantity:quantity, unitAmount:unitAmount])
                        </script>
                    </iterate>
                </iterate>
                <!--Searching for partId and person details and setting it to personList -->
                <set field="customer_details" from="[:]"/>
                <entity-find-one entity-name="mantle.party.Person" value-field="personList">
                    <field-map field-name="partyId" from="orderPartMap.customerPartyId"/>
                    <select-field field-name="partyId,firstName,middleName,lastName"/>
                </entity-find-one>
                <set field="partyId" from="personList.partyId"/>
                <set field="firstName" from="personList.firstName"/>
                <set field="middleName" from="personList.middleName"/>
                <set field="lastName" from="personList.lastName"/>
                <!--Setting all the details to orders list -->
                <set field="orders" from="orders+[orderId:orderId, orderName:orderName, currencyUomId:currencyUomId,
                 salesChannelEnumId:salesChannelEnumId, statusId:statusId, placedDate:placedDate, grandTotal:grandTotal,
                 customer_details:[partyId:partyId, firstName:firstName, middleName:middleName, lastName:lastName],
                 order_parts:[orderPartSeqId:orderPartMap.orderPartSeqId, partName:orderPartMap.partName,
                 facilityId:orderPartMap.facilityId, shipmentMethodEnumId:orderPartMap.shipmentMethodEnumId,
                 statusId:orderPartMap.statusId, partTotal:orderPartMap.partTotal, item_details:item_details]]"/>
            </iterate>
        </actions>
    </service>

    <!--    Get an Order-->

    <service verb="get" noun="orderOne" displayName="get an order">
        <in-parameters>
            <parameter name="orderId"></parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="orders" type="list">
                <parameter name="orderId"/>
                <parameter name="orderName"/>
                <parameter name="currencyUomId"/>
                <parameter name="salesChannelEnumId"/>
                <parameter name="statusId"/>
                <parameter name="placedDate"/>
                <parameter name="grandTotal"/>
                <parameter name="customer_details" type="Map">
                    <parameter name="partyId"/>
                    <parameter name="firstName"/>
                    <parameter name="middleName"/>
                    <parameter name="lastName"/>
                </parameter>
                <parameter name="order_parts" type="list">
                    <parameter name="orderMaps" type="Map">
                        <parameter name="orderPartSeqId"/>
                        <parameter name="partName"/>
                        <parameter name="facilityId"/>
                        <parameter name="shipmentMethodEnumId"/>
                        <parameter name="partStatusId"/>
                        <parameter name="partTotal"/>
                    </parameter>
                    <parameter name="item_details" type="list">
                        <parameter name="orderMaps" type="Map">
                            <parameter name="orderItemSeqId"/>
                            <parameter name="productId"/>
                            <parameter name="itemDescription"/>
                            <parameter name="quantity"/>
                            <parameter name="unitAmount"/>
                        </parameter>
                    </parameter>
                </parameter>
            </parameter>
        </out-parameters>
        <actions>
            <set field="orders" from="[]"/>
            <!-- Finding the orderId in the OrderHeader  -->
            <entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderList">
                <field-map field-name="orderId"/>
                <select-field
                        field-name="orderId,orderName,currencyUomId,salesChannelEnumId,statusId,placedDate,grandTotal"/>
            </entity-find-one>
            <set field="order_parts" from="[]"/>
            <!-- Finding the orderId in the OrderPart  -->
            <entity-find entity-name="mantle.order.OrderPart" list="orderPartList">
                <econdition field-name="orderId"/>
                <select-field
                        field-name="orderPartSeqId,partName,facilityId,shipmentMethodEnumId,statusId,partTotal,customerPartyId"/>
            </entity-find>
            <set field="customer_details" from="[:]"/>
            <!-- Finding partyId in Person  -->
            <entity-find-one entity-name="mantle.party.Person" value-field="personList">
                <field-map field-name="partyId" from="orderPartList.customerPartyId"/>
                <select-field field-name="firstName,middleName,lastName"/>
            </entity-find-one>
            <set field="item_details" from="[]"/>
            <entity-find entity-name="mantle.order.OrderItem" list="itemList">
                <econdition field-name="orderId"/>
                <econdition field-name="orderPartSeqId"/>
                <select-field field-name="orderItemSeqId,productId,itemDescription,quantity,unitAmount"/>
            </entity-find>
            <!-- Traversing orderList for orderHeader details -->
            <iterate list="orderList" entry="orderHeader">
                <set field="orderId" from="orderHeader.orderId"/>
                <set field="orderName" from="orderHeader.orderName"/>
                <set field="currencyUomId" from="orderHeader.currencyUomId"/>
                <set field="placedDate" from="orderHeader.placedDate"/>
                <set field="grandTotal" from="orderHeader.grandTotal"/>
                <iterate list="personList" entry="person">
                    <set field="firstName" from="person.firstName"/>
                    <set field="middleName" from="person.middleName"/>
                    <set field="lastName" from="person.lastName"/>
                </iterate>
                <!-- Traversing orderPartList for orderPart details -->
                <iterate list="orderPartList" entry="orderPart">
                    <set field="orderPartSeqId" from="orderPart.orderPartSeqId"/>
                    <set field="partName" from="orderPart.partName"/>
                    <set field="facilityId" from="orderPart.facilityId"/>
                    <set field="shipmentMethodEnumId" from="orderPart.shipmentMethodEnumId"/>
                    <set field="statusId" from="orderPart.statusId"/>
                    <set field="partTotal" from="orderPart.partTotal"/>
                </iterate>
                <!-- Traversing itemList for orderItem details -->
                <iterate list="itemList" entry="orderItems">
                    <set field="orderItemSeqId" from="orderItems.orderItemSeqId"/>
                    <set field="productId" from="orderItems.productId"/>
                    <set field="itemDescription" from="orderItems.itemDescription"/>
                    <set field="quantity" from="orderItems.quantity"/>
                    <set field="unitAmount" from="orderItems.unitAmount"/>
                </iterate>
                <!-- Setting Order_parts list adding the item_details  -->
                <set field="order_parts" from="order_parts+[orderPartSeqId:orderPartSeqId,partName:partName,facilityId:facilityId,
                     shipmentMethodEnumId:shipmentMethodEnumId,statusId:statusId,partTotal:partTotal,
                     item_details:[orderItemSeqId:orderItemSeqId,productId:productId,itemDescription:itemDescription,
                     quantity:quantity,unitAmount:unitAmount]]"/>
                <!-- Setting orders list and adding the customer_details's and order_part -->
                <set field="orders"
                     from="orders+[orderId:orderId,orderName:orderName,currencyUomId:currencyUomId,salesChannelEnumId:salesChannelEnumId,
                     statusId:statusId,placedDate:placedDate,grandTotal:grandTotal,
                     customer_details:[firstName:firstName,middleName:middleName,lastName:lastName],
                     order_parts:order_parts]"/>
            </iterate>
        </actions>
    </service>
    <!--    Update Order-->

    <service verb="update" noun="orderUpdate" displayName="Update an order">
        <in-parameters>
            <parameter name="orderId"/>
            <parameter name="orderName"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId"/>
            <parameter name="orderName"/>
            <parameter name="placedDate"/>
            <parameter name="approvedDate"/>
            <parameter name="statusId"/>
            <parameter name="currencyUomId"/>
            <parameter name="productStoreId"/>
            <parameter name="salesChannelEnumId"/>
            <parameter name="grandTotal"/>
        </out-parameters>
        <actions>
            <!--updating the orderHeader entity-->
            <service-call name="update#mantle.order.OrderHeader" in-map="context+[orderId:orderId]" out-map="context"/>
        </actions>
    </service>
</services>